( function( $ ) {

	var clc = wp.customize.ContentLayoutControl;

	/**
	 * Model class for the Gallery component
	 *
	 * @augments Backbone.Model
	 * @since 0.1
	 */
	clc.Models.components.gallery = clc.Models.Component.extend({
		defaults: function() {
			return {
				name:           '',
				description:    '',
				type:           'gallery',
				images:         [],
				columns:        5,
				size:           'medium',
				title:          '',
				selector_id: 	'',
				order:          0
			};
		}
	});

} )( jQuery );

( function( $ ) {

	var clc = wp.customize.ContentLayoutControl;

	/**
	 * Model class for the Components Content Block component
	 *
	 * @augments Backbone.Model
	 * @since 1.0.0
	 */
	clc.Models.components['classic-content-block'] = clc.Models.components['content-block'].extend({
		defaults: function() {
			return {
				name:           '',
				description:    '',
				type:           'classic-content-block',
				image:          0,
				image_position: 'left',
				title_line_one: '',
				title:          '',
				content:        '',
				links:          [],
				selector_id: 	'',
				order:          0
			};
		}
	});

} )( jQuery );


( function( $ ) {

	var clc = wp.customize.ContentLayoutControl;

	/**
	 * Model class for the Components Content Block component
	 *
	 * @augments Backbone.Model
	 * @since 1.0.0
	 */
	clc.Models.components['classic-content-block-two'] = clc.Models.components['content-block'].extend({
		defaults: function() {
			return {
				name:           '',
				description:    '',
				type:           'classic-content-block-two',
				image:          0,
				image_position: 'left',
				title_line_one: '',
				title:          '',
				content:        '',
				links:          [],
				selector_id: 	'',
				order:          0
			};
		}
	});

} )( jQuery );

( function( $ ) {

	var clc = wp.customize.ContentLayoutControl;

	/**
	 * Model class for the Components Hero Block component
	 *
	 * @augments clc.Models.components['content-block']
	 * @augments Backbone.Model
	 * @since 1.0.0
	 */
	clc.Models.components['classic-hero-block'] = clc.Models.components['content-block'].extend({
		defaults: function() {
			return {
				name:               '',
				description:        '',
				type:               'classic-hero-block',
				image:              0,
				image_transparency: 0,
				title_line_one:     '',
				title:              '',
				links:              [],
				contact:            '',
				selector_id: 		'',
				order:              0
			};
		}
	});

} )( jQuery );

( function( $ ) {

	var clc = wp.customize.ContentLayoutControl;

	/**
	 * Model class for the Components Content Block component
	 *
	 * @augments Backbone.Model
	 * @since 1.0.0
	 */
	clc.Models.components['classic-cta-banner'] = clc.Models.components['classic-content-block'].extend({
		defaults: function() {
			return {
				name:           '',
				description:    '',
				type:           'classic-cta-banner',
				title_line_one: '',
				title:          '',
				content:        '',
				links:          [],
				selector_id: 	'',
				order:          0
			};
		}
	});

} )( jQuery );

( function( $ ) {

	var clc = wp.customize.ContentLayoutControl;

	/**
	 * Model class for the Components Content Block component
	 *
	 * @augments Backbone.Model
	 * @since 1.0.0
	 */
	clc.Models.components['classic-cta-banner-two'] = clc.Models.components['classic-content-block'].extend({
		defaults: function() {
			return {
				name:           '',
				description:    '',
				type:           'classic-cta-banner-two',
				title_line_one: '',
				title:          '',
				content:        '',
				links:          [],
				selector_id: 	'',
				order:          0
			};
		}
	});

} )( jQuery );

( function( $ ) {

	var clc = wp.customize.ContentLayoutControl;

	/**
	 * Model class for the Recent posts component
	 *
	 * @augments Backbone.Model
	 * @since 0.1
	 */
	clc.Models.components['classic-recent-posts'] = clc.Models.Component.extend({
		defaults: function() {
			return {
				name:           '',
				description:    '',
				number:         3,
				columns:        3,
				title:          '',
				show_date:      0,
				type:           'classic-recent-posts',
				order:          0
			};
		}
	});

} )( jQuery );

( function( $ ) {

	var clc = wp.customize.ContentLayoutControl;

	/**
	 * Model class for the Recent posts component
	 *
	 * @augments Backbone.Model
	 * @since 0.1
	 */
	clc.Models.components['classic-commerce-products'] = clc.Models.Component.extend({
		defaults: function() {
			return {
				name:           '',
				description:    '',
				number:         3,
				columns:        3,
				title:          '',
				type:           'classic-commerce-products',
				order:          99
			};
		}
	});

} )( jQuery );


( function( $ ) {

	var clc = wp.customize.ContentLayoutControl;

	/**
	 * Model class for the Recent posts component
	 *
	 * @augments Backbone.Model
	 * @since 0.1
	 */
	clc.Models.components['classic-cc-on-sale'] = clc.Models.Component.extend({
		defaults: function() {
			return {
				name:           '',
				description:    '',
				number:         3,
				columns:        3,
				title:          '',
				type:           'classic-cc-on-sale',
				order:          99
			};
		}
	});

} )( jQuery );

( function( $ ) {

	var clc = wp.customize.ContentLayoutControl;

	/**
	 * View class for the Gallery form
	 *
	 * @augments wp.customize.ContentLayoutControl.Views.BaseComponentForm
	 * @augments wp.Backbone.View
	 * @since 0.1
	 */
	clc.Views.component_controls.gallery = clc.Views.BaseComponentForm.extend({
		template: wp.template( 'clc-component-gallery' ),

		className: 'clc-component-gallery',

		events: {
			'click .clc-toggle-component-form': 'toggleDisplay',
			'click .delete': 'delete',
			'blur [data-clc-setting-link]': 'updateLinkedSetting',
			'reordered': 'reordered',
			'click .select-image': 'openMedia',
		},

		image_thumb_urls: [],

		render: function() {
			wp.Backbone.View.prototype.render.apply( this );

			if ( this.image_thumb_urls.length && this.model.get( 'images' ).length ) {
				this.renderThumbs();

			// Fetch the thumbnail URL from the server if we don't yet have one
		} else if ( this.model.get( 'images' ).length ) {
				$.ajax({
					url: CLC_Control_Settings.root + '/content-layout-control/v1/components/gallery/thumb-urls/' + this.model.get( 'images' ).join( ',' ),
					type: 'GET',
					beforeSend: function( xhr ) {
						xhr.setRequestHeader( 'X-WP-Nonce', CLC_Control_Settings.nonce );
					},
					complete: _.bind( function( r ) {
						var urls = [];
						if ( typeof r.success !== 'undefined' && r.success() && typeof r.responseJSON !== 'undefined' ) {
							urls = r.responseJSON;
						}

						this.image_thumb_urls = urls;
						this.renderThumbs();
					}, this )
				});
			}
		},

		/**
		 * Open the media modal
		 *
		 * @since 0.1
		 */
		openMedia: function( event ) {
			event.preventDefault();

			if ( !this.media ) {
				this.initMedia();
			}

			this.media.open();

		},

		/**
		 * Create a media modal
		 *
		 * @since 0.1
		 */
		initMedia: function() {
			this.media = wp.media({
				state: 'gallery-library',
				frame: 'post',
			});
			this.media.on( 'close', _.bind( this.selectImage, this ) );
		},

		/**
		 * Receive the selected images from the media modal and assign them to
		 * the control
		 *
		 * @since 0.1
		 */
		selectImage: function() {
			var attachments = [],
				image_thumb_urls = [],
				library = this.media.states.get( {id: 'gallery-edit'} ).get( 'library' );

			library.each( function( model, i, collection )  {

				attachments.push( model.get( 'id') );

				if ( typeof model.get( 'sizes' ).medium !== 'undefined' && model.get( 'sizes' ).medium.width >= 238 ) {
					image_thumb_urls.push( model.get( 'sizes' ).medium.url );
				} else if ( typeof model.get( 'sizes' ).full !== 'undefined' ) {
					image_thumb_urls.push( model.get( 'sizes' ).full.url );
				} else {
					image_thumb_urls.push( '' );
				}
			} );

			this.image_thumb_urls = image_thumb_urls;
			this.model.set({
				images: attachments,
				columns: library.gallery.get('columns'),
				size: library.gallery.get('size'),
				selector_id: library.gallery.get('selector_id'),
			});
			this.render();
			wp.customize.previewer.send( 'component-changed.clc', this.model );
		},

		/**
		 * Add the image thumbnail preview
		 *
		 * This should normally be set with the template. However, in some cases
		 * we'll need to set it by making an end-run to the server to fetch the
		 * url. In such cases, we can slot it in when it returns without
		 * re-rendering the whole view.
		 *
		 * @since 0.1
		 */
		renderThumbs: function() {
			var html = '';
			for ( var i in this.image_thumb_urls ) {
				html += '<img src="' + this.image_thumb_urls[i] + '">';
			}
			this.$el.find( '.thumb' ).removeClass( 'loading' ).html( html );
		},
	});

} )( jQuery );


( function( $ ) {

	var clc = wp.customize.ContentLayoutControl;

	/**
	 * View class for the Components Content Block form
	 *
	 * @augments wp.customize.Views.component_controls['content-block']
	 * @augments wp.customize.ContentLayoutControl.Views.BaseComponentForm
	 * @augments wp.Backbone.View
	 * @since 1.0.0
	 */
	clc.Views.component_controls['classic-content-block'] = clc.Views.component_controls['content-block'].extend({
		template: wp.template( 'clc-component-classic-content-block' ),

		className: 'clc-component-classic-content-block clc-component-content-block'
	});

} )( jQuery );

( function( $ ) {

	var clc = wp.customize.ContentLayoutControl;

	/**
	 * View class for the Components Content Block form
	 *
	 * @augments wp.customize.Views.component_controls['content-block']
	 * @augments wp.customize.ContentLayoutControl.Views.BaseComponentForm
	 * @augments wp.Backbone.View
	 * @since 1.0.0
	 */
	clc.Views.component_controls['classic-content-block-two'] = clc.Views.component_controls['content-block'].extend({
		template: wp.template( 'clc-component-classic-content-block-two' ),

		className: 'clc-component-classic-content-block-two clc-component-content-block-two'
	});

} )( jQuery );

( function( $ ) {

	var clc = wp.customize.ContentLayoutControl;

	/**
	* View class for the Components Hero Block form
	*
	* @augments wp.customize.Views.component_controls['content-block']
	* @augments wp.customize.ContentLayoutControl.Views.BaseComponentForm
	* @augments wp.Backbone.View
	* @since 1.0.0
	*/
	clc.Views.component_controls['classic-hero-block'] = clc.Views.component_controls['classic-content-block'].extend({
		template: wp.template( 'clc-component-classic-hero-block' ),

		className: 'clc-component-classic-hero-block clc-component-hero-block',

		events: _.extend({}, clc.Views.component_controls['content-block'].prototype.events, {
			'change input[type="radio"]': 'contactChanged',
			'change input[type="range"]': 'imageTransparencyChanged',
		}),

		/**
		 * Update when a contact value is selected
		 *
		 * @since 1.0.0
		 */
		contactChanged: function( event ) {
			this.updateLinkedSetting( event );
			wp.customize.previewer.send( 'component-changed.clc', this.model );
			this.render();
		},

		/**
		 * Update when the image transparency has changed
		 *
		 * @since 1.0.0
		 */
		imageTransparencyChanged: function( event ) {
			this.updateLinkedSetting( event );

			var target = $( event.target );
			wp.customize.previewer.send(
				'component-setting-changed-' + this.model.get( 'id' ) + '.clc',
				{
					setting: target.data( 'clc-setting-link' ),
					val: target.val()
				}
			);
		}
	});

} )( jQuery );

( function( $ ) {

	var clc = wp.customize.ContentLayoutControl;

	/**
	 * View class for the Classic CTA Banner
	 *
	 * @augments wp.customize.Views.component_controls['content-block']
	 * @augments wp.customize.ContentLayoutControl.Views.BaseComponentForm
	 * @augments wp.Backbone.View
	 * @since 1.0.0
	 */
	clc.Views.component_controls['classic-cta-banner'] = clc.Views.component_controls['classic-content-block'].extend({
		template: wp.template( 'clc-component-classic-cta-banner' ),

		className: 'clc-component-classic-cta-banner clc-component-cta-banner'
	});

} )( jQuery );

( function( $ ) {

	var clc = wp.customize.ContentLayoutControl;

	/**
	 * View class for the Classic CTA Banner
	 *
	 * @augments wp.customize.Views.component_controls['content-block']
	 * @augments wp.customize.ContentLayoutControl.Views.BaseComponentForm
	 * @augments wp.Backbone.View
	 * @since 1.0.0
	 */
	clc.Views.component_controls['classic-cta-banner-two'] = clc.Views.component_controls['classic-content-block'].extend({
		template: wp.template( 'clc-component-classic-cta-banner-two' ),

		className: 'clc-component-classic-cta-banner-two clc-component-cta-banner-two'
	});

} )( jQuery );

( function( $ ) {

	var clc = wp.customize.ContentLayoutControl;

	/**
	 * View class for the Recent Posts form
	 *
	 * @augments wp.customize.ContentLayoutControl.Views.BaseComponentForm
	 * @augments wp.Backbone.View
	 * @since 0.1
	 */
	clc.Views.component_controls['classic-recent-posts'] = clc.Views.BaseComponentForm.extend({
		template: wp.template( 'clc-component-classic-recent-posts' ),
		
		className: 'clc-component-classic-recent-posts clc-component-recent-posts',

		events: {
			'click .clc-toggle-component-form': 'toggleDisplay',
			'click .delete': 'delete',
			'blur [data-clc-setting-link]': 'updateLinkedSetting',
			'change [data-clc-setting-link]': 'updateLinkedSetting',
			'keyup [data-clc-setting-link]': 'updateTextLive',
			'change [data-clc-show-date-link]': 'updateShowDateSetting',
			'change [data-clc-show-thumb-link]': 'updateShowThumbSetting',
			'change [data-clc-show-readmore-link]': 'updateShowReadmoreSetting',
			'reordered': 'reordered',
		},

		/**
		 * Update text inputs in the browser without triggering a full
		 * component refresh
		 *
		 * @since 0.1
		 */
		updateTextLive: function( event ) {
			var target = $( event.target );

			wp.customize.previewer.send(
				'component-setting-changed-' + this.model.get( 'id' ) + '.clc',
				{
					setting: target.data( 'clc-setting-link' ),
					val: target.val()
				}
			);
		},

		/**
		 * Update the show_date setting
		 *
		 * This can't use the updateLinkedSetting helper because it passes the
		 * value whether of a checkbox whether it's checked or not.
		 *
		 * @since 0.1
		 */
		updateShowDateSetting: function( event ) {
			var val = $( event.target ).is( ':checked' ) ? 1 : 0;

			if ( this.model.get( 'show_date' ) === val ) {
				return;
			}

			this.model.set( { show_date: val } );
		},
		
		updateShowThumbSetting: function( event ) {
			var val = $( event.target ).is( ':checked' ) ? 1 : 0;

			if ( this.model.get( 'show_thumb' ) === val ) {
				return;
			}

			this.model.set( { show_thumb: val } );
		},
		
		updateShowReadmoreSetting: function( event ) {
			var val = $( event.target ).is( ':checked' ) ? 1 : 0;

			if ( this.model.get( 'show_readmore' ) === val ) {
				return;
			}

			this.model.set( { show_readmore: val } );
		}
	});

} )( jQuery );

( function( $ ) {

	var clc = wp.customize.ContentLayoutControl;

	/**
	 * View class for the Recent Posts form
	 *
	 * @augments wp.customize.ContentLayoutControl.Views.BaseComponentForm
	 * @augments wp.Backbone.View
	 * @since 0.1
	 */
	clc.Views.component_controls['classic-commerce-products'] = clc.Views.BaseComponentForm.extend({
		template: wp.template( 'clc-component-classic-commerce-products' ),
		
		className: 'clc-component-classic-commerce-products clc-component-classic-commerce-products',

		events: {
			'click .clc-toggle-component-form': 'toggleDisplay',
			'click .delete': 'delete',
			'blur [data-clc-setting-link]': 'updateLinkedSetting',
			'change [data-clc-setting-link]': 'updateLinkedSetting',
			'keyup [data-clc-setting-link]': 'updateTextLive',
			'reordered': 'reordered',
		},

		/**
		 * Update text inputs in the browser without triggering a full
		 * component refresh
		 *
		 * @since 0.1
		 */
		updateTextLive: function( event ) {
			var target = $( event.target );

			wp.customize.previewer.send(
				'component-setting-changed-' + this.model.get( 'id' ) + '.clc',
				{
					setting: target.data( 'clc-setting-link' ),
					val: target.val()
				}
			);
		},
	});

} )( jQuery );


( function( $ ) {

	var clc = wp.customize.ContentLayoutControl;

	/**
	 * View class for the Recent Posts form
	 *
	 * @augments wp.customize.ContentLayoutControl.Views.BaseComponentForm
	 * @augments wp.Backbone.View
	 * @since 0.1
	 */
	clc.Views.component_controls['classic-cc-on-sale'] = clc.Views.BaseComponentForm.extend({
		template: wp.template( 'clc-component-classic-cc-on-sale' ),
		
		className: 'clc-component-classic-cc-on-sale clc-component-classic-cc-on-sale',

		events: {
			'click .clc-toggle-component-form': 'toggleDisplay',
			'click .delete': 'delete',
			'blur [data-clc-setting-link]': 'updateLinkedSetting',
			'change [data-clc-setting-link]': 'updateLinkedSetting',
			'keyup [data-clc-setting-link]': 'updateTextLive',
			'reordered': 'reordered',
		},

		/**
		 * Update text inputs in the browser without triggering a full
		 * component refresh
		 *
		 * @since 0.1
		 */
		updateTextLive: function( event ) {
			var target = $( event.target );

			wp.customize.previewer.send(
				'component-setting-changed-' + this.model.get( 'id' ) + '.clc',
				{
					setting: target.data( 'clc-setting-link' ),
					val: target.val()
				}
			);
		},
	});

} )( jQuery );